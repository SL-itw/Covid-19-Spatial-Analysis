---
title: "Creating the Cross-Walk for zcta to UHF"
author: "E Benn"
date: "4/12/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)


library('tigris')
library('sp')
library('rgeos')
library('readr')
#library('tmap')
library('sf')
library("readxl")
library("dplyr")
library("mosaic")

library(tidyverse)
library(tigris) 
library(leaflet)
library(tidycensus)
library(dplyr)
library(magrittr)
library(sf)
library(ggplot2)
library(leaflet)
#install.packages("leaflet.extras")
library(leaflet.extras)
library(htmlwidgets)
library(htmltools)
```

```{r}
#importing the uhf shapefile
#revise the path according to where you have the shapefile saved.
uhf.shp <- st_read("./Covid-19_NYC/UHF_42_DOHMH_2009/UHF_42_DOHMH_2009.shp")
```
I retrieved this shapefile from this github repository: https://gist.github.com/miguelpaz/edbc79fc55447ae736704654b3b2ef90 . This is the shapefile of the 42 UHF neighborhoods. We will be able to merge this with the most up to date indicator data that Bart provides. 

The 'UHF_NEIGH' variable in this dataset corresponds to the UHF value and is a numerical variable.
```{r}
#showing a general plot of the shapefile
plot(uhf.shp)

```


```{r}
#creating zcta to uhf crosswalk function for nydoh case and testing data
urlfile="https://raw.githubusercontent.com/nychealth/coronavirus-data/master/tests-by-zcta.csv"
nycdoh <- read_csv(url(urlfile))
nycdoh <- nycdoh %>% rename(zcta = MODZCTA)
nycdoh <- mutate(nycdoh, UHF_NEIGH = derivedFactor(
     "101" = (zcta  %in% c(10463, 10471)),
     "102" = (zcta %in% c(10466, 10469, 10470, 10475)),
     "103" = (zcta %in% c(10458, 10467, 10468)),
     "104" = (zcta %in% c(10461, 10462, 10464, 10465, 10472, 10473)),
     "105" = (zcta %in% c(10453, 10457, 10460)),
     "106" = (zcta %in% c(10451, 10452, 10456 )),
      "107" = (zcta %in% c(10454, 10455, 10459, 10474)),
     "201" = (zcta %in% c(11211, 11222)),
     "202" = (zcta %in% c(11201, 11205, 11215, 11217, 11231)),
     "203" = (zcta %in% c(11213, 11212, 11216, 11233, 11238)),
     "204" = (zcta %in% c(11207, 11208)),
     "205" = (zcta %in% c(11220, 11232)),
     "206" = (zcta %in% c(11204, 11218, 11219, 11230)),
     "207" = (zcta %in% c(11203, 11210, 11225, 11226)),
     "208" = (zcta %in% c(11234, 11236, 11239 )),
     "209" = (zcta %in% c(11209, 11214, 11228)), 
     "210" = (zcta %in% c(11223, 11224, 11229, 11235)), 
     "211" = (zcta %in% c(11206, 11221, 11237)),
     "301" = (zcta %in% c(10031, 10032, 10033, 10034, 10040)),
     "302" = (zcta %in% c(10026, 10027, 10030, 10037, 10039)),
     "303" = (zcta %in% c(10029, 10035)),
     "304" = (zcta %in% c(10023, 10024, 10025)),
     "305" = (zcta %in% c(10021, 10028, 10044, 10128)),
     "306" = (zcta %in% c(10001, 10011, 10018, 10019, 10020, 10036)),
     "307" = (zcta %in% c(10010, 10016, 10017, 10022)),
     "308" = (zcta %in% c(10012, 10013, 10014)),
     "309" = (zcta %in% c(10002, 10003, 10009)),
     "310" = (zcta %in% c(10004, 10005, 10006, 10007, 10038, 10280)),
     "401" = (zcta %in% c(11101, 11102, 11103, 11104, 11105, 11106)),
     "402" = (zcta %in% c(11368, 11369, 11370, 11372, 11373, 11377, 11378)),
     "403" = (zcta %in% c(11354, 11355, 11356, 11357, 11358, 11359, 11360)),
     "404" = (zcta %in% c(11361, 11362, 11363, 11364)),
     "405" = (zcta %in% c(11374, 11375, 11379, 11385)),
     "406" = (zcta %in% c(11365, 11366, 11367)),
     "407" = (zcta %in% c(11414, 11415, 11416, 11417, 11418, 11419, 11420, 11421)),
     "408" = (zcta %in% c(11412, 11423, 11432, 11433, 11434, 11435, 11436)),
     "409" = (zcta %in% c(11004, 11005, 11411, 11413, 11422, 11426, 11427, 11428, 11429)),
     "410" = (zcta %in% c(11691, 11692, 11693, 11694, 11695, 11697)),
     "501" = (zcta %in% c(10302, 10303, 10310)),
     "502" = (zcta %in% c(10301, 10304, 10305)),
     "503" = (zcta %in% c(10314)),
     "504" = (zcta %in% c(10306, 10307, 10308, 10309, 10312)),
     .method = "first",
     .default = NA
     ))

#aggregating positives and testing by UHF
nycdoh.sum <- nycdoh %>% 
  group_by(UHF_NEIGH) %>% 
  summarise(cases.uhf = sum(Positive), testing.uhf = sum(Total))

10001, 10011, 10018, 10019, 10020, 10036
```
The nycdoh.sum file can be used to merge with the uhf indicator data that Bart will provide. Bart's data will also include the population size by uhf so you can get case rate and testing rate by uhf.

```{r}
###importing UHF42 csv files directly from dropbox
airquality <- readr::read_csv(url("https://www.dropbox.com/s/bae5ca98f116lqe/Airquality.csv?dl=1"))
airquality <- airquality %>% rename(UHF_NEIGH = `Geography ID`)

ethnicity <- readr::read_csv(url("https://www.dropbox.com/s/krqd1gppptt0hkm/Ethnicity.csv?dl=1"))
ethnicity <- ethnicity %>% rename(UHF_NEIGH = `Geography ID`)

HCUrates <- readr::read_csv(url("https://www.dropbox.com/s/zf9411zk22ut80j/HCUrates.csv?dl=1"))
HCUrates <- HCUrates %>% rename(UHF_NEIGH = `Geography ID`)

prevalences <- readr::read_csv(url("https://www.dropbox.com/s/k4awv0u92ipmxb6/Prevalences.csv?dl=1"))
prevalences <- prevalences %>% rename(UHF_NEIGH = `Geography ID`)

Totpop <- readr::read_csv(url("https://www.dropbox.com/s/lzbbmko7e0drkii/TotPop.csv?dl=1"))
Totpop <- Totpop %>% rename(UHF_NEIGH = `Geography ID`)

###merging the files together with nycdoh.sum
library('plyr')
indicators <- join_all(list(nycdoh.sum, Totpop, prevalences, HCUrates, ethnicity, airquality), by="UHF_NEIGH")
detach("package:plyr", unload=TRUE) #plyr package masks some of the dplyr functions so you will want to detach it after doing the merge.

indicators <- indicators %>% mutate(case.rate = (cases.uhf/`Total Population`)*100000)

indicators <- indicators %>% mutate(test.rate = (testing.uhf/`Total Population`)*100000)


```
Joyce, the 'indicators' dataset is the one that you will use for your analysis for now. Steven, you will need to merge indicators with the uhf.shp file to do the mapping by the UHF_NEIGH variable.

\newpage

# Maps 

## Case Rate

```{r}

zipsmap <- geo_join( uhf.shp,
                    indicators %>% na.omit() %>% mutate(UHF_NEIGH = as.character(UHF_NEIGH) %>% as.numeric()),
                    by_sp = "UHFCODE", 
                        by_df = "UHF_NEIGH",
                        how = "inner") %>% 
            st_transform(., "+proj=longlat +datum=WGS84")

# get values for lower & upper "Pew breaks"
case.rate_lower <- (zipsmap$case.rate %>% quantile(0.333))
case.rate_upper <- (zipsmap$case.rate %>%  quantile(0.667))

# binned palette using Pew breaks & full-color univariate scale hex values


pal_case.rate <- colorBin(
  palette = c("#EDEDED", "#94C6E7", "#4CB1DF"),
  domain = zipsmap$case.rate,
  bins = c(min(zipsmap$case.rate, na.rm = T), case.rate_lower, case.rate_upper, max(zipsmap$case.rate, na.rm = T))
)

#labels for hover tap
 labels <- 
            paste0(
                "Neighborhood: ",
                zipsmap$UHF_NEIGH, "<br/>",
                "Case Rate: ",
                round(zipsmap$case.rate, digits = 0), "<br/>",
                "UHF CODE: ",
                zipsmap$UHFCODE,"<br/>",
                "Borough: ",
                zipsmap$BOROUGH
                ) %>%
            lapply(htmltools::HTML)
 
 
#map of case rate in NYC 

 zipsmap %>% leaflet() %>% 
  # add base map
  addProviderTiles("CartoDB") %>% 
  # add zip codes
  addPolygons(fillColor = ~pal_case.rate(case.rate),
              weight = 2,
              opacity = 1,
              color = "white",
              dashArray = "3",
              fillOpacity = 0.7,
              highlight = highlightOptions(weight = 2,
                                           color = "#666",
                                           dashArray = "",
                                           fillOpacity = 0.7,
                                           bringToFront = TRUE),
              label = labels) %>%
  # add legend
  addLegend(pal = pal_case.rate,
            values = ~round(case.rate,0), 
            opacity = 0.7, 
            title = htmltools::HTML("Case Rate <br/>per 100K"),
            position = "bottomright")
```


## Race Ethnicity

```{r}

pal_fuction_red <- function(x){
  x_lower <- (x %>% quantile(0.333))
  x_upper <- (x %>% quantile(0.667))
  
  palette =  colorBin(
    palette = c("#EDEDED", "#FF94C0", "#FF2C54"),
    domain = x,
   bins = c(min(x, na.rm = T), x_lower, x_upper, max(x, na.rm = T))
  )
}

pal_black.pct<- pal_fuction_red(zipsmap$`Percent Black Alone`)

#labels for hover tap
 labels <- 
            paste0(
                "Neighborhood: ",
                zipsmap$UHF_NEIGH, "<br/>",
                "Case Rate: ",
                round(zipsmap$case.rate, digits = 0), "<br/>",
                "UHF CODE: ",
                zipsmap$UHFCODE,"<br/>",
                "Borough: ",
                zipsmap$BOROUGH, "<br/>",
                "Non Hispanic Black: %",
                zipsmap$`Percent Black Alone`
                ) %>%
            lapply(htmltools::HTML)
 
 
#map of case rate in NYC 

 zipsmap %>% leaflet(
   width = "100%",
          options = leafletOptions(zoomSnap = 0.25, zoomDelta = 0.5)
 ) %>% 
  # add base map
  addProviderTiles("CartoDB") %>% 
  # add zip codes
  addPolygons(group = "Non Hispanic Black Pct",
              fillColor = ~pal_black.pct(`Percent Black Alone`),
              weight = 2,
              opacity = 0.5,
              color = "white",
              dashArray = "3",
              fillOpacity = 0.7,
              stroke = F,
              smoothFactor = 0.2,
              highlight = highlightOptions(weight = 2,
                                           color = "#666",
                                           dashArray = "",
                                           fillOpacity = 0.7,
                                           bringToFront = TRUE)) %>% 
   addPolygons(
              fillColor = ~pal_case.rate(case.rate),
              weight = 2,
              opacity = 0.5,
              color = "white",
              dashArray = "3",
              fillOpacity = 0.7,
              stroke = F,
              smoothFactor = 0.2,
              highlight = highlightOptions(weight = 2,
                                           color = "#666",
                                           dashArray = "",
                                           fillOpacity = 0.7,
                                           bringToFront = TRUE)) %>% 
        
        addPolygons(
          label = lapply(labels, htmltools::HTML),
          labelOptions = labelOptions(textsize = "12px"),
          fillColor = NA,
          fillOpacity = 0,
          color = "gray",
          weight = 1,
          opacity = 1,
          highlightOptions = highlightOptions(weight = 2)) %>% 
        
        addResetMapButton() %>% 
        
        addFullscreenControl() %>% 
        
        suspendScroll(sleepNote = F, sleepOpacity = 1) %>% 
        
        addControl(
            
          html = "<img src = 'https://sl4269.github.io/zipsmap_UHF_Blackpct.svg' width = '128' height = '128'>",
          position = "topright",
          className = "legend-bivar"
        )
```

